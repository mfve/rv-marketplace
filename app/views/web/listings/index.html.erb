<div class="px-4 py-6 sm:px-0">
  <div class="mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">RV Listings</h1>
      <p class="mt-2 text-sm text-gray-600">Browse available RV rentals</p>
    </div>
    <a href="/listings/new" id="create-listing-btn" class="hidden bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">
      Create Listing
    </a>
  </div>

  <div id="listings-container" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
    <!-- Listings will be loaded here via JavaScript -->
  </div>

  <div id="loading" class="text-center py-12">
    <p class="text-gray-500">Loading listings...</p>
  </div>

  <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
    <p>Failed to load listings. Please try again later.</p>
  </div>
</div>

<script>
// Wait for both DOM and API to be ready
(function() {
  function initListings() {
    const container = document.getElementById('listings-container');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');

    if (!container || !loading || !error) {
      return; // Elements not ready yet
    }

    // Check if API is available
    if (typeof window.API === 'undefined') {
      console.error('API not available, retrying...');
      setTimeout(initListings, 100);
      return;
    }

    // Show create listing button if logged in
    const createListingBtn = document.getElementById('create-listing-btn');
    if (createListingBtn) {
      if (window.API.token) {
        createListingBtn.classList.remove('hidden');
      } else {
        createListingBtn.classList.add('hidden');
      }
    }

    // Hide loading and fetch listings
    (async () => {
      try {
        const response = await window.API.get('/api/listings');
        loading.classList.add('hidden');

        if (response.listings && response.listings.length > 0) {
          response.listings.forEach(listing => {
            const card = document.createElement('div');
            card.className = 'bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow flex flex-col';
            card.innerHTML = `
              <div class="h-48 bg-gray-200 flex items-center justify-center">
                <span class="text-gray-400 text-sm">Image placeholder</span>
              </div>
              <div class="p-6 flex flex-col h-full">
                <h3 class="text-lg font-medium text-gray-900 mb-2">${escapeHtml(listing.title)}</h3>
                <p class="text-sm text-gray-600 mb-4 line-clamp-2 flex-grow">${escapeHtml(listing.description)}</p>
                <div class="flex justify-between items-end mt-auto">
                  <div>
                    <p class="text-sm text-gray-500">${escapeHtml(listing.location)}</p>
                    <p class="text-lg font-semibold text-indigo-600">$${listing.price_per_day}/day</p>
                  </div>
                  <a href="/listings/${listing.id}" class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700 whitespace-nowrap ml-4">
                    View Details
                  </a>
                </div>
              </div>
            `;
            container.appendChild(card);
          });
        } else {
          container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-12">No listings available</p>';
        }
      } catch (err) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        console.error('Error loading listings:', err);
      }
    })();
  }

  // Try to initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initListings);
  } else {
    // DOM is already ready, but wait a bit for API
    setTimeout(initListings, 100);
  }
})();

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
