<div class="px-4 py-6 sm:px-0">
  <div id="loading" class="text-center py-12">
    <p class="text-gray-500">Loading listing...</p>
  </div>

  <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
    <p>Failed to load listing. Please try again later.</p>
  </div>

  <div id="listing-details" class="hidden">
    <div class="bg-white shadow rounded-lg overflow-hidden">
      <!-- Image placeholder -->
      <div class="h-96 bg-gray-200 flex items-center justify-center">
        <span class="text-gray-400 text-lg">Image placeholder</span>
      </div>

      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h1 id="listing-title" class="text-3xl font-bold text-gray-900"></h1>
          <div id="owner-actions" class="hidden flex space-x-2">
            <a href="#" id="edit-listing-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
              Edit Listing
            </a>
            <button id="delete-listing-btn" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700">
              Delete Listing
            </button>
          </div>
        </div>
        <div class="flex items-center space-x-4 mb-4">
          <span id="listing-location" class="text-gray-600"></span>
          <span id="listing-price" class="text-2xl font-semibold text-indigo-600"></span>
        </div>
        <p id="listing-description" class="text-gray-700 mb-6"></p>

        <div id="booking-section" class="border-t pt-6">
          <h2 class="text-xl font-semibold mb-4">Book this RV</h2>
          
          <!-- Error display area -->
          <div id="booking-errors" class="hidden mb-4 bg-red-50 border border-red-200 rounded-md p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Unable to create booking</h3>
                <div id="booking-errors-list" class="mt-2 text-sm text-red-700">
                  <!-- Errors will be displayed here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Success message -->
          <div id="booking-success" class="hidden mb-4 bg-green-50 border border-green-200 rounded-md p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-green-800">Booking created successfully!</p>
              </div>
            </div>
          </div>

          <form id="booking-form" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" id="start-date" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" id="end-date" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              </div>
            </div>
            <button type="submit" id="booking-submit-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-md font-medium hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
              Book Now
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Owner's bookings section -->
    <div id="owner-bookings" class="hidden mt-8 bg-white shadow rounded-lg p-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Bookings for this Listing</h2>
      <div id="bookings-list" class="space-y-4">
        <!-- Bookings will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const listingId = window.location.pathname.split('/').pop();
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const details = document.getElementById('listing-details');
  const ownerBookings = document.getElementById('owner-bookings');

  try {
    const listingResponse = await window.API.get(`/api/listings/${listingId}`);
    const listing = listingResponse.listing;
    loading.classList.add('hidden');
    details.classList.remove('hidden');

    document.getElementById('listing-title').textContent = listing.title;
    document.getElementById('listing-location').textContent = listing.location;
    document.getElementById('listing-price').textContent = `$${listing.price_per_day}/day`;
    document.getElementById('listing-description').textContent = listing.description;

    // Show edit/delete buttons if user is logged in (backend will handle authorization)
    const ownerActions = document.getElementById('owner-actions');
    const editListingBtn = document.getElementById('edit-listing-btn');
    const deleteListingBtn = document.getElementById('delete-listing-btn');
    
    if (window.API && window.API.token) {
      ownerActions.classList.remove('hidden');
      editListingBtn.href = `/listings/${listingId}/edit`;
      
      // Delete button handler
      deleteListingBtn.addEventListener('click', async () => {
        if (confirm('Are you sure you want to delete this listing?')) {
          try {
            await window.API.delete(`/api/listings/${listingId}`);
            alert('Listing deleted successfully!');
            window.location.href = '/listings';
          } catch (err) {
            const errorMsg = err.errors ? err.errors.join(', ') : (err.message || 'Failed to delete listing');
            alert(errorMsg);
            console.error('Delete error:', err);
          }
        }
      });
    }

    // Check if user owns this listing and load bookings
    if (window.API && window.API.token) {
      try {
        const bookings = await window.API.get('/api/bookings');
        const listingBookings = bookings.listing_bookings || [];
        const thisListingBookings = listingBookings.filter(b => {
          // Handle both direct rv_listing_id and nested rv_listing object
          const listingIdMatch = b.rv_listing_id == listingId || (b.rv_listing && b.rv_listing.id == listingId);
          return listingIdMatch;
        });

        if (thisListingBookings.length > 0) {
          ownerBookings.classList.remove('hidden');
          const bookingsList = document.getElementById('bookings-list');
          thisListingBookings.forEach(booking => {
            const bookingCard = document.createElement('div');
            bookingCard.className = 'border rounded-lg p-4';
            bookingCard.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium">${booking.start_date} to ${booking.end_date}</p>
                  <p class="text-sm text-gray-600">Status: <span class="font-semibold">${booking.status}</span></p>
                </div>
                ${booking.status === 'pending' ? `
                  <div class="flex space-x-2">
                    <button onclick="confirmBooking(${booking.id})" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700">
                      Confirm
                    </button>
                    <button onclick="rejectBooking(${booking.id})" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm hover:bg-red-700">
                      Reject
                    </button>
                  </div>
                ` : ''}
              </div>
            `;
            bookingsList.appendChild(bookingCard);
          });
        }
      } catch (err) {
        console.error('Error loading bookings:', err);
      }
    }

    // Set min date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start-date').min = today;
    document.getElementById('end-date').min = today;

    // Booking form handler
    const bookingForm = document.getElementById('booking-form');
    const bookingErrors = document.getElementById('booking-errors');
    const bookingErrorsList = document.getElementById('booking-errors-list');
    const bookingSuccess = document.getElementById('booking-success');
    const submitBtn = document.getElementById('booking-submit-btn');

    bookingForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Hide previous messages
      bookingErrors.classList.add('hidden');
      bookingSuccess.classList.add('hidden');
      
      if (!window.API || !window.API.token) {
        window.location.href = '/login';
        return;
      }

      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      try {
        const response = await window.API.post('/api/bookings', {
          rv_listing_id: listingId,
          start_date: startDate,
          end_date: endDate
        });

        // Check for errors in response
        if (response.errors && response.errors.length > 0) {
          // Display errors
          bookingErrorsList.innerHTML = '<ul class="list-disc list-inside space-y-1">' +
            response.errors.map(error => `<li>${escapeHtml(error)}</li>`).join('') +
            '</ul>';
          bookingErrors.classList.remove('hidden');
          
          // Scroll to errors
          bookingErrors.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          // Show success message
          bookingSuccess.classList.remove('hidden');
          
          // Redirect after a short delay
          setTimeout(() => {
            window.location.href = '/bookings';
          }, 1500);
        }
      } catch (err) {
        // Handle API errors
        let errorMessages = ['Failed to create booking. Please try again.'];
        
        // Try to extract error messages from the error object
        if (err.errors && Array.isArray(err.errors)) {
          errorMessages = err.errors;
        } else if (err.response && err.response.errors && Array.isArray(err.response.errors)) {
          errorMessages = err.response.errors;
        } else if (err.message) {
          // Check if message contains multiple errors (comma-separated)
          if (err.message.includes(',')) {
            errorMessages = err.message.split(',').map(m => m.trim());
          } else {
            errorMessages = [err.message];
          }
        }
        
        bookingErrorsList.innerHTML = '<ul class="list-disc list-inside space-y-1">' +
          errorMessages.map(error => `<li>${escapeHtml(String(error))}</li>`).join('') +
          '</ul>';
        bookingErrors.classList.remove('hidden');
        bookingErrors.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        console.error('Booking error:', err);
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Book Now';
      }
    });
  } catch (err) {
    loading.classList.add('hidden');
    error.classList.remove('hidden');
    console.error('Error loading listing:', err);
  }
});

async function confirmBooking(bookingId) {
  if (!confirm('Confirm this booking?')) return;
  try {
    await window.API.post(`/api/bookings/${bookingId}/confirm`);
    location.reload();
  } catch (err) {
    const errorMsg = err.errors ? err.errors.join(', ') : (err.message || 'Failed to confirm booking');
    alert(errorMsg);
    console.error('Confirm error:', err);
  }
}

async function rejectBooking(bookingId) {
  if (!confirm('Reject this booking?')) return;
  try {
    await window.API.post(`/api/bookings/${bookingId}/reject`);
    location.reload();
  } catch (err) {
    const errorMsg = err.errors ? err.errors.join(', ') : (err.message || 'Failed to reject booking');
    alert(errorMsg);
    console.error('Reject error:', err);
  }
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
