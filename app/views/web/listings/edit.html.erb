<div class="px-4 py-6 sm:px-0">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Edit Listing</h1>
    <p class="mt-2 text-sm text-gray-600">Update the details for your RV listing.</p>
  </div>

  <!-- Error display area -->
  <div id="listing-errors" class="hidden mb-4 bg-red-50 border border-red-200 rounded-md p-4">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800">Unable to update listing</h3>
        <div id="listing-errors-list" class="mt-2 text-sm text-red-700">
          <!-- Errors will be displayed here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Success message area -->
  <div id="listing-success" class="hidden mb-4 bg-green-50 border border-green-200 rounded-md p-4">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-green-800">Listing updated successfully! Redirecting...</h3>
      </div>
    </div>
  </div>

  <div id="loading" class="text-center py-12">
    <p class="text-gray-500">Loading listing...</p>
  </div>

  <div class="bg-white shadow rounded-lg p-6">
    <form id="edit-listing-form" class="space-y-6">
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
        <input type="text" id="title" name="title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
      </div>
      <div>
        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
        <textarea id="description" name="description" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
      </div>
      <div>
        <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
        <input type="text" id="location" name="location" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
      </div>
      <div>
        <label for="price_per_day" class="block text-sm font-medium text-gray-700">Price per Day</label>
        <input type="number" id="price_per_day" name="price_per_day" step="0.01" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
      </div>
      <div class="flex justify-end">
        <button type="submit" id="update-listing-submit-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-md font-medium hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
          Update Listing
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const listingId = window.location.pathname.split('/')[2]; // Get ID from /listings/:id/edit
  const form = document.getElementById('edit-listing-form');
  const errorsDiv = document.getElementById('listing-errors');
  const errorsList = document.getElementById('listing-errors-list');
  const successDiv = document.getElementById('listing-success');
  const submitBtn = document.getElementById('update-listing-submit-btn');
  const loading = document.getElementById('loading');

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Check if user is logged in
  if (!window.API || !window.API.token) {
    alert('Please login to edit a listing.');
    window.location.href = '/login';
    return;
  }

  // Fetch existing listing data and populate the form
  try {
    const response = await window.API.get(`/api/listings/${listingId}`);
    const listing = response.listing;

    if (listing) {
      loading.classList.add('hidden');
      document.getElementById('title').value = listing.title;
      document.getElementById('description').value = listing.description;
      document.getElementById('location').value = listing.location;
      document.getElementById('price_per_day').value = listing.price_per_day;
    } else {
      errorsList.innerHTML = '<li>Listing not found.</li>';
      errorsDiv.classList.remove('hidden');
      submitBtn.disabled = true;
      loading.classList.add('hidden');
    }
  } catch (err) {
    loading.classList.add('hidden');
    errorsList.innerHTML = '<li>Failed to load listing data.</li>';
    errorsDiv.classList.remove('hidden');
    submitBtn.disabled = true;
    console.error('Error loading listing for edit:', err);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    errorsDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';

    const listingData = {
      title: document.getElementById('title').value,
      description: document.getElementById('description').value,
      location: document.getElementById('location').value,
      price_per_day: parseFloat(document.getElementById('price_per_day').value)
    };

    try {
      const response = await window.API.put(`/api/listings/${listingId}`, listingData);

      if (response.listing) {
        successDiv.classList.remove('hidden');
        setTimeout(() => {
          window.location.href = `/listings/${response.listing.id}`;
        }, 1500);
      } else if (response.errors) {
        errorsList.innerHTML = '<ul class="list-disc list-inside space-y-1">' +
          response.errors.map(error => `<li>${escapeHtml(error)}</li>`).join('') +
          '</ul>';
        errorsDiv.classList.remove('hidden');
        errorsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    } catch (err) {
      let errorMessages = ['Failed to update listing. Please try again.'];
      if (err.errors && Array.isArray(err.errors)) {
        errorMessages = err.errors;
      } else if (err.response && err.response.errors && Array.isArray(err.response.errors)) {
        errorMessages = err.response.errors;
      } else if (err.message) {
        if (err.message.includes(',')) {
          errorMessages = err.message.split(',').map(m => m.trim());
        } else {
          errorMessages = [err.message];
        }
      }
      errorsList.innerHTML = '<ul class="list-disc list-inside space-y-1">' +
        errorMessages.map(error => `<li>${escapeHtml(String(error))}</li>`).join('') +
        '</ul>';
      errorsDiv.classList.remove('hidden');
      errorsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      console.error('Update listing error:', err);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Listing';
    }
  });
});
</script>
