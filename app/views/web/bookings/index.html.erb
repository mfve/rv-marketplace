<div class="px-4 py-6 sm:px-0">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">My Bookings</h1>
    <p class="mt-2 text-sm text-gray-600">Manage your bookings</p>
  </div>

  <div id="loading" class="text-center py-12">
    <p class="text-gray-500">Loading bookings...</p>
  </div>

  <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
    <p>Failed to load bookings. Please try again later.</p>
  </div>

  <div id="bookings-content" class="hidden">
    <!-- Outgoing Bookings -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Outgoing Bookings</h2>
      <p class="text-sm text-gray-600 mb-4">Bookings you've made for other listings</p>
      <div id="outgoing-bookings" class="space-y-4">
        <!-- Outgoing bookings will be loaded here -->
      </div>
      <div id="no-outgoing" class="hidden text-center py-8 bg-gray-50 rounded-lg">
        <p class="text-gray-500">You don't have any outgoing bookings</p>
      </div>
    </div>

    <!-- Incoming Bookings -->
    <div>
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Incoming Bookings</h2>
      <p class="text-sm text-gray-600 mb-4">Bookings others have made for your listings</p>
      <div id="incoming-bookings" class="space-y-4">
        <!-- Incoming bookings will be loaded here -->
      </div>
      <div id="no-incoming" class="hidden text-center py-8 bg-gray-50 rounded-lg">
        <p class="text-gray-500">You don't have any incoming bookings</p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const content = document.getElementById('bookings-content');
  const outgoingContainer = document.getElementById('outgoing-bookings');
  const incomingContainer = document.getElementById('incoming-bookings');
  const noOutgoing = document.getElementById('no-outgoing');
  const noIncoming = document.getElementById('no-incoming');

  if (!API.token) {
    loading.classList.add('hidden');
    error.classList.remove('hidden');
    error.innerHTML = '<p>Please <a href="/login" class="underline">login</a> to view your bookings</p>';
    return;
  }

  try {
    const response = await API.get('/api/bookings');
    loading.classList.add('hidden');
    content.classList.remove('hidden');

    const outgoingBookings = response.bookings || [];
    const incomingBookings = response.listing_bookings || [];

    // Display outgoing bookings
    if (outgoingBookings.length > 0) {
      outgoingBookings.forEach(booking => {
        const card = createBookingCard(booking, false);
        outgoingContainer.appendChild(card);
      });
    } else {
      noOutgoing.classList.remove('hidden');
    }

    // Display incoming bookings
    if (incomingBookings.length > 0) {
      incomingBookings.forEach(booking => {
        const card = createBookingCard(booking, true);
        incomingContainer.appendChild(card);
      });
    } else {
      noIncoming.classList.remove('hidden');
    }
  } catch (err) {
    loading.classList.add('hidden');
    error.classList.remove('hidden');
    console.error('Error loading bookings:', err);
  }
});

function createBookingCard(booking, isIncoming) {
  const card = document.createElement('div');
  card.className = 'bg-white border rounded-lg p-6 shadow-sm';
  
  const statusColors = {
    pending: 'bg-yellow-100 text-yellow-800',
    confirmed: 'bg-green-100 text-green-800',
    rejected: 'bg-red-100 text-red-800'
  };

  const statusClass = statusColors[booking.status] || 'bg-gray-100 text-gray-800';

  card.innerHTML = `
    <div class="flex justify-between items-start">
      <div class="flex-1">
        <div class="flex items-center space-x-3 mb-2">
          <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">
            ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
          </span>
        </div>
        <p class="text-lg font-medium text-gray-900 mb-1">
          ${booking.start_date} to ${booking.end_date}
        </p>
        ${booking.rv_listing ? `
          <p class="text-sm text-gray-600">Listing: ${escapeHtml(booking.rv_listing.title || 'N/A')}</p>
          <p class="text-sm text-gray-500">Location: ${escapeHtml(booking.rv_listing.location || 'N/A')}</p>
        ` : ''}
      </div>
      ${isIncoming && booking.status === 'pending' ? `
        <div class="flex space-x-2 ml-4">
          <button onclick="confirmBooking(${booking.id})" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700">
            Confirm
          </button>
          <button onclick="rejectBooking(${booking.id})" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700">
            Reject
          </button>
        </div>
      ` : ''}
    </div>
  `;

  return card;
}

async function confirmBooking(bookingId) {
  if (!confirm('Confirm this booking?')) return;
  try {
    await API.post(`/api/bookings/${bookingId}/confirm`);
    location.reload();
  } catch (err) {
    alert('Failed to confirm booking');
    console.error('Confirm error:', err);
  }
}

async function rejectBooking(bookingId) {
  if (!confirm('Reject this booking?')) return;
  try {
    await API.post(`/api/bookings/${bookingId}/reject`);
    location.reload();
  } catch (err) {
    alert('Failed to reject booking');
    console.error('Reject error:', err);
  }
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
